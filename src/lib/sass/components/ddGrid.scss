/*
	DivoDivnoe Grid
	Зависит от "DivoDivnoe Responsive", "DivoDivnoe Space"
*/

$dd-grid-columns: 12 !default;
$dd-grid-gutterContainer: $dd-space-defaultSpace !default;
$dd-grid-gutterHorizontal: $dd-space-defaultSpace !default;
$dd-grid-gutterVertical: $dd-space-defaultSpace !default;
$dd-grid-dynamicGutters: true;
$dd-grid-spaceGutters: true;

// Генерирует сетку в заданном направлении
// используя grid-подобный синтаксис
@mixin dd-grid-template($_dir, $_params)
{
	$_lngs: ();
	// Формируем массив сумм величин по их измерениям
	// px: 250px, em: 100em, fr: 3fr
	@each $_param in $_params {
		@if not unitless($_param) {
			$_unit: unit($_param);
			$_newVal: null;
			@if map-has-key($_lngs, $_unit) {
				$_newVal: map-get($_lngs, $_unit) + $_param;
			} @else {
				$_newVal: $_param;
			}
			$_newMap: ($_unit:$_newVal);
			$_lngs: map-merge($_lngs, $_newMap);
		}
	}
	// Итоговая строка для calc, в виде 100% - 150px - 15em
	$_calcString: '100%';
	// Сумма для fr размерности
	$_calcSum: 0;
	@each $_unit, $_lng in $_lngs {
		@if $_unit == fr {
			$_calcSum: $_calcSum + dd-helpers-stripUnits($_lng);
		} @else {
			$_calcString: $_calcString + ' - #{$_lng}';
		}
	}

	display: flex;
	@if $_dir == row {
		flex-direction: row;
	} @else {
		flex-direction: column;
	}

	$_i: 1;
	@each $_param in $_params {
		& > *:nth-child(#{$_i}) {
			@if unitless($_param) {
				flex-grow: $_param;
				@if $_param > 0 {
					flex-shrink: 1;
				} @else {
					flex-shrink: 0;
				}
			} @else {
				flex-grow: 0;
				flex-shrink: 0;
				@if unit($_param) == fr {
					@if $_dir == row {
						width: calc((#{$_calcString}) * #{dd-helpers-stripUnits($_param)/$_calcSum});
					} @else {
						height: calc((#{$_calcString}) * #{dd-helpers-stripUnits($_param)/$_calcSum});
					}
				} @else {
					@if $_dir == row {
						width: $_param;
					} @else {
						height: $_param;
					}
				}
			}
		}
		$_i: $_i + 1;
	}
}

@mixin dd-grid-templateColumns($params...)
{
	@include dd-grid-template(row, $params)
}

@mixin dd-grid-templateRows($params...)
{
	@include dd-grid-template(col, $params)
}

@mixin _dd-grid-guttersStatic($_gutterH, $_gutterV)
{
	@if ($_gutterH != 0) {
		margin-left: -$_gutterH/2;
		margin-right: -$_gutterH/2;
	}
	@if ($_gutterV != 0) {
		margin-bottom: -$_gutterV/2;
		margin-top: -$_gutterV/2;
	}

	& > * {
		@if ($_gutterH != 0) {
			padding-left: $_gutterH/2;
			padding-right: $_gutterH/2;
		}
		@if ($_gutterV != 0) {
			padding-bottom: $_gutterV/2;
			padding-top: $_gutterV/2;
		}
	}
}

@mixin _dd-grid-guttersDynamic($_gutterH, $_gutterV)
{
	@each $_key, $_params in $dd-responsive-breakpoints {
		$_range: map_get($_params, 'range');
		$_minWidth: nth($_range, 1);
		$_maxWidth: nth($_range, 2);

		$_spaceScale: map_get($_params, 'spaceScale');

		@if ($_maxWidth) {
			@media all and ( min-width: $_minWidth ) and ( max-width: $_maxWidth ) {
				@include _dd-grid-guttersStatic($_spaceScale * $_gutterH, $_spaceScale * $_gutterV);
			}
		} @else {
			@media all and ( min-width: $_minWidth ) {
				@include _dd-grid-guttersStatic($_spaceScale * $_gutterH, $_spaceScale * $_gutterV);
			}
		}
	}
}

@mixin _dd-grid-guttersStaticSpaces($_gutterH, $_gutterV)
{
	@each $_factorKey, $_factorVal in $dd-space-factor {
		$_val: dd-space-getSpace($_factorKey);

		&._#{$_factorKey} {
			@include _dd-grid-guttersStatic($_factorVal * $_gutterH, $_factorVal * $_gutterV);
		}
	}
}

@mixin _dd-grid-guttersDynamicSpaces($_gutterH, $_gutterV)
{
	@each $_key, $_params in $dd-responsive-breakpoints {
		$_range: map_get($_params, 'range');
		$_minWidth: nth($_range, 1);
		$_maxWidth: nth($_range, 2);

		$_spaceScale: map_get($_params, 'spaceScale');

		@if ($_maxWidth) {
			@media all and ( min-width: $_minWidth ) and ( max-width: $_maxWidth ) {
				@include _dd-grid-guttersStaticSpaces($_spaceScale * $_gutterH, $_spaceScale * $_gutterV);
			}
		} @else {
			@media all and ( min-width: $_minWidth ) {
				@include _dd-grid-guttersStaticSpaces($_spaceScale * $_gutterH, $_spaceScale * $_gutterV);
			}
		}
	}
}

@mixin dd-grid-gutters($_gutterH: $dd-grid-gutterHorizontal, $_gutterV: $dd-grid-gutterVertical, $_gutterDynamic: false, $_spaces: false)
{
	$_gutterH: dd-space-getSpace($_gutterH);
	$_gutterV: dd-space-getSpace($_gutterV);

	@if ($_gutterDynamic) {
		@include _dd-grid-guttersDynamic($_gutterH, $_gutterV);

		@if ($_spaces) {
			@include _dd-grid-guttersDynamicSpaces($_gutterH, $_gutterV);
		}

	} @else {
		@include _dd-grid-guttersStatic($_gutterH, $_gutterV);

		@if ($_spaces) {
			@include _dd-grid-guttersStaticSpaces($_gutterH, $_gutterV);
		}
	}
}

@mixin dd-grid-cell($_grow: 1, $_shrink: 1)
{
	box-sizing: border-box;
	flex-grow: $_grow;
	flex-shrink: $_shrink;
	flex-basis: auto;
	min-width: 0;
	min-height: 0;
}

@mixin dd-grid-area($_gutterH: $dd-grid-gutterHorizontal, $_gutterV: $dd-grid-gutterVertical, $_gutterDynamic: $dd-grid-dynamicGutters, $_spaces: $dd-grid-spaceGutters)
{
	$_gutterH: dd-space-getSpace($_gutterH);
	$_gutterV: dd-space-getSpace($_gutterV);

	display: flex;
	flex-direction: row;
	flex-wrap: wrap;
	min-width: 0;

	@if ($_gutterV != 0) {
		&:empty::after, &:blank::after {
			content: '';
			height: $_gutterV*2;
		}
	}

	& > * {
		@include dd-grid-cell();
		width: 100%;
	}

	@include dd-grid-gutters($_gutterH, $_gutterV, $_gutterDynamic, $_spaces);
}

@mixin _dd-grid-listMedia($_params)
{
	@if (map_get($_params, 'columns') != null) {
		$_params: map_merge($_params, (
			cellWidth: percentage(1/map_get($_params, 'columns'))
		));
	}

	margin-left: - map_get($_params, 'gutterHorizontal')/2;
	margin-right: - map_get($_params, 'gutterHorizontal')/2;
	margin-bottom: - map_get($_params, 'gutterVertical');
	margin-top: - map_get($_params, 'gutterVertical');

	& > * {
		@if (map_get($_params, 'cellWidth') != null) {
			width: map_get($_params, 'cellWidth');
			flex-grow: 0;
			flex-shrink: 0;
		}
		padding-left: map_get($_params, 'gutterHorizontal')/2;
		padding-right: map_get($_params, 'gutterHorizontal')/2;
		margin-bottom: map_get($_params, 'gutterVertical');
		margin-top: map_get($_params, 'gutterVertical');
	}
}

/*
	@include dd-grid-list(
		(
			columns: 5,
			gutterVertical: 16px,
			gutterHorizontal: small,
		),
		(
			media: ((sm, md), xl),
			columns: 3,
		),
		(
			media: ((360px, 500px)),
			gutterVertical: tiny,
		),
	)
*/
@mixin dd-grid-list($_args...)
{
	$_defaults: (
		columns: null,
		gutterVertical: $dd-grid-gutterVertical,
		gutterHorizontal: $dd-grid-gutterHorizontal,
	);
	@for $_i from 1 through length($_args) {
		$_arg: nth($_args, $_i);
		$_media: map_get($_arg, 'media');
		$_params: ();
		@if ($_media == null) {
			$_defaults: map_merge($_defaults, $_arg);
			$_params: $_defaults;
		} @else {
			$_params: map_merge($_defaults, $_arg);
		}

		$_params: map_merge($_params, (
			gutterVertical: dd-space-getSpace(map_get($_params, 'gutterVertical')),
			gutterHorizontal: dd-space-getSpace(map_get($_params, 'gutterHorizontal')),
		));

		@if ($_media == null) {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			min-width: 0;

			& > * {
				@include dd-grid-cell();
			}

			&:empty::after, &:blank::after {
				content: '';
				height: map_get($_params, 'gutterVertical')*2;
			}

			@include _dd-grid-listMedia($_params);

		} @else {

			@media #{dd-helpers-implode(dd-responsive-parseMedia($_media), ', ')} {
				@include _dd-grid-listMedia($_params);
			}
		}
	}
}

.#{$dd-system-classPrefix}grid {

	&-container {
		box-sizing: border-box;
		padding: 0 $dd-grid-gutterHorizontal;
		margin: 0 auto;

		&._#{$dd-system-classPrefix}fluid {
			width: 100%;
		}
	}

	&-area {
		@include dd-grid-area($dd-grid-gutterHorizontal, $dd-grid-gutterVertical, true, true);

		&._center {
			justify-content: center;
		}
	}
}

// Генерируем селектор для всех ячеек с заданным размером
$_cellSelector: '';
@each $_key, $_params in $dd-responsive-breakpoints {
	@for $j from 1 through $dd-grid-columns {
		$_cellSelector: $_cellSelector + '.#{$dd-system-classPrefix}grid-cell._#{$_key}-#{$j}';
		@if (not dd-responsive-nextBreakpoint($_key) and $j == $dd-grid-columns) {} @else {
			$_cellSelector: $_cellSelector + ', ';
		}
	}
}
// Запрещаем растягивание ячеек, для которых задан размер
#{$_cellSelector} {
	flex-grow: 0;
	flex-shrink: 0;
}

.#{$dd-system-classPrefix}grid {

	// Генерируем стили для брейкпойтнов
	@each $_key, $_params in $dd-responsive-breakpoints {
		$_range: map_get($_params, 'range');
		$_minWidth: nth($_range, 1);
		$_containerWidth: map_get($_params, 'containerWidth');

		$_spaceScale: map_get($_params, 'spaceScale');
		$_gutterContainer: $_spaceScale * $dd-grid-gutterContainer;

		// Размеры ячеек сетки
		@media all and ( min-width: $_minWidth ) {
			&-container {
				width: $_containerWidth;
				padding-left: $_gutterContainer;
				padding-right: $_gutterContainer;
			}
			@for $j from 1 through $dd-grid-columns {
				&-area {
					& > .#{$dd-system-classPrefix}grid-cell._#{$_key}-#{$j} {
						width: percentage($j / $dd-grid-columns);
					}
				}
			}
		}
	}
}